{
"map" : "function zeroPad(n) { return n>=10 ? n : '0'+n; }; function getMonday(dateString) { var dateString = dateString.replace(/-/g, '/'); var date = new Date(dateString); var day = date.getDay(), diff = date.getDate() - day + (day == 0 ? -6:1); var weekStartDate = new Date(date.setDate(diff)); return weekStartDate.getFullYear() + '-' + zeroPad(weekStartDate.getMonth()+1) + '-' + zeroPad(weekStartDate.getDate()); }; function(doc) { if(doc.documentType == 'DosageAdherenceLog') { emit([doc.patientId, getMonday(doc.dosageDate)], {\"taken\":doc.dosageStatus==\"TAKEN\"?1:0, \"date\": getMonday(doc.dosageDate)}) } }",
"reduce" : "function (key, values, rereduce) {var weekStartDate = ''; var taken = 0; var total = 0; if(!rereduce) { weekStartDate = values[0].date; taken = sum(values.map(function(elt) {return elt.taken})); total = values.length; } else { weekStartDate = values[0].weekStartDate; for(var i in values) { taken = taken + values[i].taken; total = total + values[i].total; } } return {\"weekStartDate\":weekStartDate, \"taken\":taken, \"total\":total};}"
}

